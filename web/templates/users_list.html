{{define "users-content"}}
<section class="mb-24">
    <!-- Error Alert (if any) -->
    {{if .ErrorMessage}}
    <div id="error-alert" class="fixed top-4 right-4 z-50 w-96">
        <div class="bg-red-900 border-red-700 text-red-200 border rounded-lg shadow-lg p-4 flex items-start gap-3 animate-slide-in" role="alert">
            <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            </svg>
            <div class="flex-grow text-sm font-medium">{{.ErrorMessage}}</div>
            <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 text-red-400 hover:text-red-300">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>
    {{end}}

    <!-- Header -->
    <header class="flex gap-2 mb-6">
        <div class="flex-grow">
            <div class="flex flex-wrap justify-between items-center gap-x-4 gap-y-2">
                <div class="flex items-center">
                    <h1 class="text-3xl font-semibold tracking-tight leading-tight">Users</h1>
                </div>
            </div>
            <p class="mt-2 max-w-[40rem] text-gray-400">
                Manage the users in your network and their permissions.
            </p>
        </div>
    </header>

    <!-- Info Panels -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <!-- Create Users Panel -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
            <div class="flex items-start gap-3">
                <div class="bg-gray-700 rounded-lg p-2">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <line x1="19" x2="19" y1="8" y2="14"></line>
                        <line x1="22" x2="16" y1="11" y2="11"></line>
                    </svg>
                </div>
                <div class="flex-grow">
                    <h3 class="font-semibold text-gray-100 mb-1">Create users</h3>
                    <p class="text-sm text-gray-400 mb-3">Create users to organize machines in your network.</p>
                    <button
                        onclick="showCreateUserModal()"
                        data-testid="create-user-button"
                        class="text-sm font-medium text-blue-400 hover:text-blue-300">
                        Create a user
                    </button>
                </div>
            </div>
        </div>

        <!-- Pre-Auth Keys Panel -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
            <div class="flex items-start gap-3">
                <div class="bg-gray-700 rounded-lg p-2">
                    <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </div>
                <div class="flex-grow">
                    <h3 class="font-semibold text-gray-100 mb-1">Pre-authentication keys</h3>
                    <p class="text-sm text-gray-400">Generate keys to register machines to specific users.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User count badge -->
    <div class="inline-flex items-center align-middle justify-center font-medium border border-gray-700 bg-gray-800 text-gray-300 rounded-full px-2 py-1 leading-none text-sm mb-8">
        {{len .Users}} users
    </div>

    <!-- Users table -->
    <div id="users-table">
        {{if .Users}}
        <table class="tb bg-gray-800 rounded-lg shadow-sm">
            <thead>
                <tr>
                    <th class="md:w-2/5">User</th>
                    <th class="hidden md:table-cell">Machines</th>
                    <th class="hidden lg:table-cell">Created</th>
                    <th class="hidden lg:table-cell">Last Seen</th>
                    <th class="w-16"></th>
                </tr>
            </thead>
            <tbody>
                {{range .Users}}
                <tr class="group hover:bg-gray-700">
                    <td class="md:w-2/5">
                        <div class="flex items-center gap-3">
                            <!-- Avatar: Profile pic if available (OIDC), otherwise initials -->
                            {{if .HasProfilePic}}
                            <img src="{{.ProfilePicURL}}" alt="{{.DisplayName}}" class="flex-shrink-0 w-10 h-10 rounded-full">
                            {{else}}
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm">
                                {{.Initials}}
                            </div>
                            {{end}}
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-semibold text-gray-100" data-testid="user-display-name">{{.DisplayName}}</p>
                                    {{if .HasProvider}}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-900 text-blue-300">
                                        {{.ProviderBadge}}
                                    </span>
                                    {{end}}
                                </div>
                                {{if ne .DisplayName .Name}}
                                <p class="text-sm text-gray-400">{{.Name}}</p>
                                {{else}}
                                <p class="text-sm text-gray-400">ID: {{.ID}}</p>
                                {{end}}
                            </div>
                        </div>
                    </td>
                    <td class="hidden md:table-cell">
                        <span class="text-sm text-gray-400">{{.MachineCount}} machines</span>
                    </td>
                    <td class="hidden lg:table-cell">
                        <span class="text-sm text-gray-400">{{.CreatedAtShort}}</span>
                    </td>
                    <td class="hidden lg:table-cell">
                        <span class="text-sm">
                            {{if .HasConnectedMachine}}
                            <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                            {{else}}
                            <span class="inline-block w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                            {{end}}
                            {{.LastSeenShort}}
                        </span>
                    </td>
                    <td class="w-16">
                        <div class="flex justify-end">
                            <details class="relative">
                                <summary data-testid="user-menu-button" class="p-2 text-gray-400 hover:text-gray-200 hover:bg-gray-700 rounded-md cursor-pointer list-none">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                    </svg>
                                </summary>
                                <!-- Dropdown Menu -->
                                <div data-testid="user-menu-dropdown" class="absolute right-0 mt-2 w-56 bg-gray-800 rounded-md shadow-lg ring-1 ring-gray-700 z-10">
                                    <div class="py-1">
                                        <a href="#" data-testid="user-menu-rename" onclick="showRenameModal('{{.ID}}', '{{.Name}}'); return false;" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">
                                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                                            </svg>
                                            Rename user
                                        </a>
                                        <a href="#" data-testid="user-menu-preauth" onclick="showPreAuthKeyModal('{{.ID}}', '{{.Name}}'); return false;" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">
                                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
                                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                            </svg>
                                            Generate pre-auth key
                                        </a>
                                        <hr class="my-1 border-gray-700">
                                        <a href="#" data-testid="user-menu-delete" onclick="showDeleteModal('{{.ID}}', '{{.Name}}'); return false;" class="block px-4 py-2 text-sm text-red-400 hover:bg-red-900 hover:bg-opacity-30">
                                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path d="M3 6h18"></path>
                                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                            </svg>
                                            Delete user
                                        </a>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <div class="bg-gray-800 rounded-lg shadow-sm p-12 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-100">No users found</h3>
            <p class="mt-1 text-sm text-gray-400">Get started by creating your first user.</p>
        </div>
        {{end}}
    </div>
</section>

<!-- Create User Modal -->
<dialog id="createUserModal" data-testid="create-user-modal" class="rounded-lg shadow-xl p-0 bg-gray-800 backdrop:bg-gray-900 backdrop:bg-opacity-75">
    <div class="p-5 w-96 bg-gray-800 rounded-lg">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-100 mb-4">Create New User</h3>
            <form id="createUserForm" hx-post="/users" hx-swap="none">
                <div class="mb-4">
                    <label for="createUserName" class="block text-sm font-medium text-gray-300 mb-1">User Name</label>
                    <input
                        type="text"
                        name="name"
                        id="createUserName"
                        data-testid="create-user-input"
                        required
                        placeholder="Enter user name"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-500 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex gap-2 justify-end">
                    <button
                        type="button"
                        onclick="document.getElementById('createUserModal').close()"
                        class="px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                    <button
                        type="submit"
                        data-testid="create-user-submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<!-- Rename Modal -->
<dialog id="renameModal" data-testid="rename-modal" class="rounded-lg shadow-xl p-0 bg-gray-800 backdrop:bg-gray-900 backdrop:bg-opacity-75">
    <div class="p-5 w-96 bg-gray-800 rounded-lg">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-100 mb-4">Rename User</h3>
            <form id="renameForm" method="POST" hx-post="" hx-target="body" hx-swap="outerHTML" hx-push-url="true">
                <input type="hidden" name="old_name" id="renameOldName">
                <div class="mb-4">
                    <label for="renameNewName" class="block text-sm font-medium text-gray-300 mb-1">New Name</label>
                    <input
                        type="text"
                        name="new_name"
                        id="renameNewName"
                        data-testid="rename-input"
                        required
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex gap-2 justify-end">
                    <button
                        type="button"
                        data-testid="rename-cancel"
                        onclick="document.getElementById('renameModal').close()"
                        class="px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                    <button
                        type="submit"
                        data-testid="rename-submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Rename
                    </button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<!-- Delete Confirmation Modal -->
<dialog id="deleteModal" data-testid="delete-modal" class="rounded-lg shadow-xl p-0 bg-gray-800 backdrop:bg-gray-900 backdrop:bg-opacity-75">
    <div class="p-5 w-96 bg-gray-800 rounded-lg">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-100 mb-4">Delete User</h3>
            <p class="text-sm text-gray-400 mb-4">
                Are you sure you want to delete user <span id="deleteUserName" class="font-semibold text-gray-100"></span>?
                This action cannot be undone.
            </p>
            <form id="deleteForm" method="POST" hx-post="" hx-target="body" hx-swap="outerHTML" hx-push-url="true">
                <div class="flex gap-2 justify-end">
                    <button
                        type="button"
                        data-testid="delete-cancel"
                        onclick="document.getElementById('deleteModal').close()"
                        class="px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                    <button
                        type="submit"
                        data-testid="delete-submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<!-- PreAuth Key Modal -->
<dialog id="preAuthKeyModal" data-testid="preauth-modal" class="rounded-lg shadow-xl p-0 bg-gray-800 backdrop:bg-gray-900 backdrop:bg-opacity-75">
    <div class="p-5 w-96 bg-gray-800 rounded-lg">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-100 mb-4">Generate Pre-Auth Key</h3>
            <form id="preAuthKeyForm" hx-post="" hx-target="#generatedKeyContainer" hx-swap="innerHTML">
                <input type="hidden" name="user_id" id="preAuthUserID">
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="ephemeral" value="true" data-testid="preauth-ephemeral" class="mr-2">
                        <span class="text-sm text-gray-300">Ephemeral (removed when offline)</span>
                    </label>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="reusable" value="true" data-testid="preauth-reusable" class="mr-2">
                        <span class="text-sm text-gray-300">Reusable</span>
                    </label>
                </div>
                <div class="mb-4">
                    <label for="expirationHours" class="block text-sm font-medium text-gray-300 mb-1">Expiration (hours)</label>
                    <input
                        type="number"
                        name="expiration_hours"
                        id="expirationHours"
                        data-testid="preauth-expiration"
                        value="1"
                        min="1"
                        class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="generatedKeyContainer" data-testid="preauth-key-container" class="mb-4">
                    <!-- Generated key will be swapped in here by HTMX -->
                </div>
                <div class="flex gap-2 justify-end">
                    <button
                        type="button"
                        data-testid="preauth-close"
                        onclick="document.getElementById('preAuthKeyModal').close(); document.getElementById('generatedKeyContainer').innerHTML = '';"
                        class="px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
                        Close
                    </button>
                    <button
                        type="submit"
                        data-testid="preauth-generate"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Generate
                    </button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<script>
// Show modal functions
function showCreateUserModal() {
    document.getElementById('createUserModal').showModal();
}

function showRenameModal(userID, userName) {
    const form = document.getElementById('renameForm');
    document.getElementById('renameOldName').value = userID;
    document.getElementById('renameNewName').value = userName;
    form.setAttribute('hx-post', '/users/' + userID + '/rename');
    htmx.process(form);
    document.getElementById('renameModal').showModal();
}

function showDeleteModal(userID, userName) {
    const form = document.getElementById('deleteForm');
    document.getElementById('deleteUserName').textContent = userName;
    form.setAttribute('hx-post', '/users/' + userID + '/delete');
    htmx.process(form);
    document.getElementById('deleteModal').showModal();
}

function showPreAuthKeyModal(userID, userName) {
    const form = document.getElementById('preAuthKeyForm');
    document.getElementById('preAuthUserID').value = userID;
    form.setAttribute('hx-post', '/users/' + userID + '/preauth-keys');
    htmx.process(form);
    document.getElementById('generatedKeyContainer').innerHTML = '';
    document.getElementById('preAuthKeyModal').showModal();
}

// Copy to clipboard function (only JS that's needed)
function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = 'Copied!';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 1500);
    });
}

// Close modals on successful form submissions - HTMX will follow redirects automatically
document.body.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        const formId = event.detail.elt.id;

        if (formId === 'createUserForm') {
            document.getElementById('createUserModal').close();
        } else if (formId === 'renameForm') {
            document.getElementById('renameModal').close();
        } else if (formId === 'deleteForm') {
            document.getElementById('deleteModal').close();
        }
        // preAuthKeyForm doesn't redirect - it swaps content into the modal
    }
});

// Close dropdown menus when clicking outside
document.addEventListener('click', function(event) {
    // Find all open details elements (dropdown menus)
    const openDetails = document.querySelectorAll('details[open]');

    openDetails.forEach(function(details) {
        // Check if the click was outside this details element
        if (!details.contains(event.target)) {
            details.removeAttribute('open');
        }
    });
});
</script>
{{end}}

{{define "users_list.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Headscale Admin</title>
    <script src="/static/js/tailwind-3.4.17.js"></script>
    <script src="/static/js/htmx-1.9.10.min.js"></script>
    <script src="/static/js/htmx-sse-1.9.10.js"></script>
    {{template "layout-styles"}}
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" hx-ext="sse" sse-connect="/events">
    {{template "layout-header" .}}
    <main class="container mx-auto pb-20 md:pb-24">
        {{template "users-content" .}}
    </main>
</body>
</html>
{{end}}
